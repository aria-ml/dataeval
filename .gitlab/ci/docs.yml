### DOCS STAGE JOBS ###

docs:
  stage: docs
  extends:
    - .nox
    - .rules_main_mr_docs
  image: nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04
  needs: []
  tags:
    - $DOCS_RUNNER_TAG
  before_script:
    - apt update && apt install curl git graphviz -y
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - uv tool install nox --with nox-uv
  script:
    - uvx nox -e docs $DOCS_CLEAN
  artifacts:
    paths:
      - output/docs/.jupyter_cache/
      - output/docs/html/
    when: always
  variables:
    UV_INSTALL_DIR: /usr/local/bin
    UV_COMPILE_BYTECODE: 1
    UV_NO_PROGRESS: true
    DATAEVAL_NOX_UV_EXTRAS_OVERRIDE: cu124

doclint:
  stage: docs
  extends:
    - .nox
    - .rules_main_mr_docs_skip_cache_update
  script:
    - uvx nox -e doclint

doctest:
  stage: docs
  extends:
    - .nox
    - .rules_main_mr_docs_skip_cache_update
  script:
    - uvx nox -e doctest

linkchecker:
  stage: docs
  extends: .rules_main_mr_docs_skip_cache_update
  needs: []
  image:
    name: ghcr.io/tcort/markdown-link-check:stable
    entrypoint: ['/bin/sh', '-c']
  script:
    - markdown-link-check --config docs/.markdown-link-check.json *.md
    - markdown-link-check --config docs/.markdown-link-check.json ./docs/source

markdownlint:
  stage: docs
  extends: .rules_main_mr_docs_skip_cache_update
  needs: []
  image:
    name: davidanson/markdownlint-cli2
    entrypoint: ['']
  script: |
    markdownlint-cli2 README.md || FAIL=1
    markdownlint-cli2 CONTRIBUTING.md || FAIL=1
    markdownlint-cli2 'docs/**/*.md' '#node_modules' || FAIL=1
    exit $FAIL
