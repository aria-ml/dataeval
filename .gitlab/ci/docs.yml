### DOCS STAGE JOBS ###

docs:
  stage: docs
  extends:
    - .nox
    - .rules_main_mr_docs
  image: nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04
  needs: []
  tags:
    - $DOCS_RUNNER_TAG
  before_script:
    - apt update && apt install curl git graphviz -y
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - uv tool install nox --with nox-uv
  script:
    - if [ "$CI_COMMIT_BRANCH" != "main" ]; then bash docs/fetch-docs-cache.sh || true; fi
    - uvx nox -P 3.13 -e docs $DOCS_CLEAN
    - bash docs/push-docs-cache.sh
  artifacts:
    paths:
      - output/docs/html/
    when: always
  variables:
    UV_INSTALL_DIR: /usr/local/bin
    UV_COMPILE_BYTECODE: 1
    UV_NO_PROGRESS: true
    DATAEVAL_NOX_UV_EXTRAS_OVERRIDE: cu124
    GIT_STRATEGY: clone  # Full clone needed for artifact branch operations

doclint:
  stage: docs
  extends:
    - .nox
    - .rules_main_mr_docs
  script:
    - uvx nox -e doclint

doctest:
  stage: docs
  extends:
    - .nox
    - .rules_main_mr_docs
  script:
    - uvx nox -e doctest

linkchecker:
  stage: docs
  extends: .rules_main_mr_docs
  needs: []
  image:
    name: ghcr.io/tcort/markdown-link-check:stable
    entrypoint: ['/bin/sh', '-c']
  script:
    - markdown-link-check --config docs/.markdown-link-check.json *.md
    - markdown-link-check --config docs/.markdown-link-check.json ./docs/source
  # Allow failures in link checking to avoid blocking merges due to transient issues
  # and anti-scraping measures on some sites. Warnings should be reviewed and addressed.
  allow_failure: true

markdownlint:
  stage: docs
  extends: .rules_main_mr_docs
  needs: []
  image:
    name: davidanson/markdownlint-cli2
    entrypoint: ['']
  script: |
    markdownlint-cli2 README.md || FAIL=1
    markdownlint-cli2 CONTRIBUTING.md || FAIL=1
    markdownlint-cli2 'docs/**/*.md' '#node_modules' || FAIL=1
    exit $FAIL
