#!/bin/bash

echo -e "\033[1;31mPlease ensure this script runs to completion!\033[0m"
echo

# Check for uv
if ! $(which uv 1> /dev/null); then echo "Install uv to continue: https://docs.astral.sh/uv/"; exit 1; fi

allowed=(3.10 3.11 3.12 3.13 3.14)
default=3.11
cuda_allowed=(cpu cu118 cu124 cu128)
cuda_default=cu118
venv_default=.venv

# Parse command line arguments
python_version=""
device_input=""
venv_name=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--python)
            python_version="$2"
            shift 2
            ;;
        -d|--device)
            device_input="$2"
            shift 2
            ;;
        -n|--name)
            venv_name="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [-p|--python <version>] [-d|--device <cuda_version>] [-n|--name <venv_name>]"
            echo "  -p, --python   Python version (${allowed[*]})"
            echo "  -d, --device   PyTorch device version (${cuda_allowed[*]})"
            echo "  -n, --name     Virtual environment directory name (default: .venv)"
            echo ""
            echo "If options are not provided, the script will prompt for them interactively."
            exit 1
            ;;
    esac
done

# Prompt for python version if not provided
if [[ -z "$python_version" ]]; then
    read -p "Enter desired version of python [supported: ${allowed[*]}] [default: ${default}]: " python_version
fi

# Parse and validate python version
if [[ -z "$python_version" ]]; then
    python_version=$default
else
    python_version=$(echo $python_version | cut -d '.' -f 1,2)
    if [[ ! " ${allowed[*]} " =~ [[:space:]]${python_version}[[:space:]] ]]; then
        echo "Unrecognized version '$python_version', defaulting to ${default}"
        python_version=$default
    fi
fi

# Prompt for CUDA version if not provided
if [[ -z "$device_input" ]]; then
    read -p "Enter desired CUDA version [supported: ${cuda_allowed[*]}] [default: ${cuda_default}]: " device_input
fi

# Parse and validate CUDA version
if [[ -z "$device_input" ]]; then
    cuda_version=$cuda_default
else
    if [[ " ${cuda_allowed[*]} " =~ [[:space:]]${device_input}[[:space:]] ]]; then
        cuda_version=$device_input
    else
        echo "Unrecognized CUDA version '$device_input', defaulting to ${cuda_default}"
        cuda_version=$cuda_default
    fi
fi

# Set venv name
if [[ -z "$venv_name" ]]; then
    venv_name=$venv_default
fi

echo "Installing Python ${python_version}+${cuda_version} to ${venv_name}"

# Install dataeval environment
export UV_PROJECT_ENVIRONMENT=$venv_name
echo "Creating python virtual environment for ${python_version}..."
rm -rf $UV_PROJECT_ENVIRONMENT
if [[ "$cuda_version" == "cpu" ]]; then
    onnx_extra="onnx"
else
    onnx_extra="onnx-gpu"
fi
uv sync -p $python_version --extra $cuda_version --extra $onnx_extra
echo $cuda_version > .cuda-version

echo "Finished installing dataeval for python ${python_version} to ${venv_name}"
echo

echo
if [[ -v $REMOTE_CONTAINERS ]]; then
    echo -e "\033[1;37mActivate your desired virtual environment (e.g. \033[1;32msource ${venv_name}/bin/activate\033[1;37m) before proceeding."
else
    echo -e '\033[1;37mIt is now safe to reload the window (\033[1;32mDeveloper: Reload Window\033[1;37m) and select a Python interpreter (\033[1;32mPython: Select Interpreter\033[1;37m) from the Command Palette.'
fi
echo
